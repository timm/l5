<!DOCTYPE html>

<html>
<head>
  <title>tmp.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>tmp.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              <p>For a list of coding conventions in this file, see 
<a href="https://github.com/timm/lua/blob/main/src/sam/eg.lua">eg.lua</a>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> l=<span class="hljs-built_in">require</span><span class="hljs-string">&quot;lib&quot;</span>
<span class="hljs-keyword">local</span> the=l.settings(<span class="hljs-string">[[   
SAM : Semi-supervised And Multi-objective explainations
(c) 2022 Tim Menzies &lt;timm@ieee.org&gt; BSD-2 license

USAGE: lua eg.lua [OPTIONS]

OPTIONS:
 -e  --eg     start-up example         = nothing
 -h  --help   show help                = false
 -n  --nums   how many numbers to keep = 256
 -p  --p      distance coeffecient     = 2
 -s  --seed   random number seed       = 10019]]</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>Commonly used lib functions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> o,oo,per,push = l.o,l.oo,l.per, l.push</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <h2 id="classes">Classes</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">local</span> Data,Cols,Sym,Num,Row</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Holder of <code>rows</code> and their sumamries (in <code>cols</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Data</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> {cols=<span class="hljs-literal">nil</span>,  <span class="hljs-comment">-- summaries of data</span>
                        rows={}    <span class="hljs-comment">-- kept data</span>
                       } <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Holds of summaries of columns. 
Columns are created once, then may appear in  multiple slots.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Cols</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> {
  names={},  <span class="hljs-comment">-- all column names</span>
  all={},    <span class="hljs-comment">-- all the columns (including the skipped ones)</span>
  klass=<span class="hljs-literal">nil</span>, <span class="hljs-comment">-- symbolic klass column (if it exists)</span>
  x={},      <span class="hljs-comment">-- independent columns (that are not skipped)</span>
  y={}       <span class="hljs-comment">-- depedent columns (that are not skipped)</span>
  } <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Summarizers a stream of symbols.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Sym</span><span class="hljs-params">(c,s)</span></span> 
  <span class="hljs-keyword">return</span> {n=<span class="hljs-number">0</span>,          <span class="hljs-comment">-- items seen</span>
          at=c <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,    <span class="hljs-comment">-- column position</span>
          name=s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-comment">-- column name</span>
          _has={}       <span class="hljs-comment">-- kept data</span>
         } <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>Summarizes a stream of numbers.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num</span><span class="hljs-params">(c,s)</span></span> 
  <span class="hljs-keyword">return</span> {n=<span class="hljs-number">0</span>,at=c <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, name=s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>, _has={}, <span class="hljs-comment">-- as per Sym</span>
          isNum=<span class="hljs-literal">true</span>,      <span class="hljs-comment">-- mark that this is a number</span>
          lo= <span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>,   <span class="hljs-comment">-- lowest seen</span>
          hi= -<span class="hljs-built_in">math</span>.<span class="hljs-built_in">huge</span>,  <span class="hljs-comment">-- highest seen</span>
          sorted=<span class="hljs-literal">true</span>,    <span class="hljs-comment">-- no updates since last sort of data</span>
          w=(s <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>):<span class="hljs-built_in">find</span><span class="hljs-string">&quot;-$&quot;</span> <span class="hljs-keyword">and</span> <span class="hljs-number">-1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-comment">-- minimizing if w=-1</span>
         } <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>Holds one record</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Row</span><span class="hljs-params">(t)</span></span> <span class="hljs-keyword">return</span> {cells=t,         <span class="hljs-comment">-- one record</span>
                        cooked=i.copy(t) <span class="hljs-comment">-- used if we discretize data</span>
                       } <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <h2 id="data-functions">Data Functions</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">local</span> add,adds,clone,div,mid,norm,nums,record,records,stats</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <h3 id="create">Create</h3>

            </div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Generate rows from some <code>src</code>.  If <code>src</code> is a string, read rows from file; 
else read rows from a <code>src</code>  table. When reading, use row1 to define columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">records</span><span class="hljs-params">(src,      data,head,body)</span></span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">head</span><span class="hljs-params">(sNames)</span></span>
    <span class="hljs-keyword">local</span> cols = Cols()
    cols.names = namess
    <span class="hljs-keyword">for</span> c,s <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(sNames) <span class="hljs-keyword">do</span>
      <span class="hljs-keyword">local</span> col = push(cols.all, <span class="hljs-comment">-- Numerics start with Uppercase. </span>
                       (s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;^[A-Z]*&quot;</span> <span class="hljs-keyword">and</span> Num <span class="hljs-keyword">or</span> Sym)(c,s))
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;:$&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-comment">-- some columns are skipped</span>
        push(s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;[!+-]&quot;</span> <span class="hljs-keyword">and</span> cols.y <span class="hljs-keyword">or</span> cols.x, col) <span class="hljs-comment">-- some cols are goal cols</span>
        <span class="hljs-keyword">if</span> s:<span class="hljs-built_in">find</span><span class="hljs-string">&quot;!$&quot;</span>    <span class="hljs-keyword">then</span> cols.klass=col <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">return</span> cols 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">------------</span>
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">body</span><span class="hljs-params">(t)</span></span> <span class="hljs-comment">-- treat first row differently (defines the columns)</span>
    <span class="hljs-keyword">if</span> data.cols <span class="hljs-keyword">then</span> record(data,t) <span class="hljs-keyword">else</span> data.cols=head(t) <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">----------</span>
  data =  Data()
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(src)==<span class="hljs-string">&quot;string&quot;</span> <span class="hljs-keyword">then</span> l.csv(src, body) <span class="hljs-keyword">else</span> 
    <span class="hljs-keyword">for</span> _,t <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(src <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> body(t) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">return</span> data <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Return a new data with same structure as <code>data1</code>. Optionally, oad in <code>rows</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clone</span><span class="hljs-params">(data1,  rows)</span></span>
  data2=Data()
  data2.cols = _head(data1.cols.names)
  <span class="hljs-keyword">for</span> _,row <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(rows <span class="hljs-keyword">or</span> {}) <span class="hljs-keyword">do</span> record(data2,row) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> data2 <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <h3 id="update">Update</h3>

            </div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>Add one thing to <code>col</code>. For Num, keep at most <code>nums</code> items.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span><span class="hljs-params">(col,v)</span></span>
  <span class="hljs-keyword">if</span> v~=<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span>
    col.n = col.n + <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> col.isNum <span class="hljs-keyword">then</span> col._has[v] = <span class="hljs-number">1</span> + (col._has[v] <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>) <span class="hljs-keyword">else</span> 
       col.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(v, col.lo)
       col.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(v, col.hi)
       <span class="hljs-keyword">local</span> pos
       <span class="hljs-keyword">if</span>     #col._has &lt; the.nums           <span class="hljs-keyword">then</span> pos = <span class="hljs-number">1</span> + (#col._has) 
       <span class="hljs-keyword">elseif</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>() &lt; the.nums/col.n <span class="hljs-keyword">then</span> pos = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">random</span>(#col._has) <span class="hljs-keyword">end</span>
       <span class="hljs-keyword">if</span> pos <span class="hljs-keyword">then</span> col.sorted = <span class="hljs-literal">false</span> 
                   col._has[pos] = <span class="hljs-built_in">tonumber</span>(v) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>Add many things to col</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adds</span><span class="hljs-params">(col,t)</span></span> <span class="hljs-keyword">for</span> _,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(t) <span class="hljs-keyword">do</span> add(col,v) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> col <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>Add a <code>row</code> to <code>data</code>. Calls <code>add()</code> to  updatie the <code>cols</code> with new values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">record</span><span class="hljs-params">(data,xs)</span></span>
  <span class="hljs-keyword">local</span> row= push(data.rows, xs.cells <span class="hljs-keyword">and</span> xs <span class="hljs-keyword">or</span> Row(xs)) <span class="hljs-comment">-- ensure xs is a Row</span>
  <span class="hljs-keyword">for</span> _,todo <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>{data.cols.x, data.cols.y} <span class="hljs-keyword">do</span>
    <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(todo) <span class="hljs-keyword">do</span> 
      add(col, row.cells[col.at]) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <h3 id="query">Query</h3>

            </div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>Return kept numbers, sorted. </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nums</span><span class="hljs-params">(num)</span></span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> num.sorted <span class="hljs-keyword">then</span> <span class="hljs-built_in">table</span>.<span class="hljs-built_in">sort</span>(num._has); num.sorted=<span class="hljs-literal">true</span> <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> num._has <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-19">&#x00a7;</a>
              </div>
              <p>Normalized numbers 0..1. Everything else normalizes to itself.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">norm</span><span class="hljs-params">(col,n)</span></span> 
  <span class="hljs-keyword">return</span> x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> col.isNum <span class="hljs-keyword">and</span> x <span class="hljs-keyword">or</span>  (n-col.lo)/(col.hi-col.lo + <span class="hljs-number">1E-32</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-20">&#x00a7;</a>
              </div>
              <p>Diversity (standard deviation for Nums, entropy for Syms)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">div</span><span class="hljs-params">(col)</span></span>
  <span class="hljs-keyword">if</span>  col.isNum <span class="hljs-keyword">then</span> <span class="hljs-keyword">local</span> a=nums(col); <span class="hljs-keyword">return</span> (per(a,<span class="hljs-number">.9</span>)-per(a,<span class="hljs-number">.1</span>))/<span class="hljs-number">2.58</span> <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span><span class="hljs-params">(p)</span></span> <span class="hljs-keyword">return</span> p*<span class="hljs-built_in">math</span>.<span class="hljs-built_in">log</span>(p,<span class="hljs-number">2</span>) <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">local</span> e=<span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> _,n <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col._has) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> n&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> e=e-fun(n/col.n) <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> e <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-21">&#x00a7;</a>
              </div>
              <p>Central tendancy (median for Nums, mode for Syms)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">mid</span><span class="hljs-params">(col)</span></span>
  <span class="hljs-keyword">if</span> col.isNum <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> per(nums(col),<span class="hljs-number">.5</span>) <span class="hljs-keyword">else</span> 
    <span class="hljs-keyword">local</span> most,mode = <span class="hljs-number">-1</span>
    <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(col._has) <span class="hljs-keyword">do</span> <span class="hljs-keyword">if</span> v&gt;most <span class="hljs-keyword">then</span> mode,most=k,v <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> mode <span class="hljs-keyword">end</span> <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-22">&#x00a7;</a>
              </div>
              <p>For <code>showCols</code> (default=<code>data.cols.x</code>) in <code>data</code>, report <code>fun</code> (default=<code>mid</code>).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stats</span><span class="hljs-params">(data,  showCols,fun,    t)</span></span>
  showCols, fun = showCols <span class="hljs-keyword">or</span> data.cols.y, fun <span class="hljs-keyword">or</span> mid
  t={}; <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(showCols) <span class="hljs-keyword">do</span> t[col.name]=fun(col) <span class="hljs-keyword">end</span>; <span class="hljs-keyword">return</span> t <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-23">&#x00a7;</a>
              </div>
              <h2 id="distance-functions">Distance functions</h2>

            </div>
            
            <div class="content"><div class='highlight'><pre>

<span class="hljs-keyword">local</span> dist</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-24">&#x00a7;</a>
              </div>
              <p>Distance between rows (returns 0..1). For unknown values, assume max distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dist</span><span class="hljs-params">(data,t1,t2)</span></span>
  <span class="hljs-keyword">local</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fun</span><span class="hljs-params">(col,  v1,v2)</span></span>
    <span class="hljs-keyword">if</span>   v1==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">and</span> v2==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> col.isNum <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> v1==v2 <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> <span class="hljs-keyword">end</span> 
    v1,v2 = norm(col,v1), norm(col,v2)
    <span class="hljs-keyword">if</span> v1==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> v1 = v2&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span> 
    <span class="hljs-keyword">if</span> v2==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> v2 = v1&lt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">0</span> <span class="hljs-keyword">end</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(v1-v2) 
  <span class="hljs-keyword">end</span> <span class="hljs-comment">-------</span>
  <span class="hljs-keyword">local</span> d = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> _,col <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(data.cols.x) <span class="hljs-keyword">do</span> 
    d = d + fun(col, t1.cells[col.at], t2.cells[col.at])^the.p <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (d/#data.cols.x)^(<span class="hljs-number">1</span>/the.p) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-25">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-26">&#x00a7;</a>
              </div>
              <p>That’s all folks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">return</span> {the=the, 
        Data=Data, Cols=Cols, Sym=Sym, Num=Num, Row=Row, 
        add=add, adds=adds, clone=clone, dist=dist,  div=div,
        mid=mid, nums=nums, records=records, record=record, stats=stats}</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
